# Dryer - ESP32-C3 Устройство для сушки

## Описание проекта

Dryer - это встраиваемое устройство на базе ESP32-C3, предназначенное для автоматической сушки с контролем температуры. Устройство управляется через MQTT протокол и включает в себя нагревательный элемент, вентилятор и датчик температуры DS18B20.

## Архитектура системы

### Основные компоненты

1. **Система управления состоянием** (`dryer/mod.rs`)
   - `State` - атомарное состояние устройства (активно/неактивно)
   - `StateMessage` - сообщения для MQTT о текущем состоянии

2. **Система нагрева** (`dryer/heater/mod.rs`)
   - `Heater` - основной контроллер нагревателя
   - `TempSensor` - трейт для датчиков температуры
   - `FanSpeedRegulator` - трейт для управления вентилятором
   - Режимы работы: нагрев, сушка, охлаждение

3. **Система вентиляции** (`dryer/fan/mod.rs`)
   - `Fan` - управление вентилятором через PWM
   - Поддержка режимов: максимальная скорость, средняя скорость, выключен

4. **Датчик температуры** (`dryer/sensor/temperature.rs`)
   - `DS18B20Sensor` - реализация датчика DS18B20
   - Поддержка OneWire протокола

5. **MQTT клиент** (`mqtt/mod.rs`)
   - `Mqtt` - клиент для связи с MQTT брокером
   - `Command` - команды Start/Stop
   - `Credentials` - учетные данные для подключения

6. **WiFi подключение** (`wifi/mod.rs`)
   - `Connection` - управление WiFi соединением
   - `Credentials` - учетные данные WiFi

7. **Система таймеров** (`time/timer/mod.rs`)
   - `SyncTimer` - синхронный таймер с возможностью отмены
   - `OnceIn` - ограничитель частоты выполнения операций

8. **Планировщик задач** (`schedule/mod.rs`)
   - `Scheduler` - планировщик периодических задач
   - `PeriodicJob` - периодические задания

## Аппаратная конфигурация

### Подключения GPIO:
- **GPIO2** - Управление нагревательным элементом (выход)
- **GPIO4** - PWM управление вентилятором (LEDC канал 0)
- **GPIO6** - OneWire датчик температуры DS18B20

### Настройки PWM:
- Частота: 20 кГц
- Разрешение: 10 бит
- Таймер: LEDC Timer 0

## Логика работы

### Алгоритм сушки:
1. **Нагрев** - когда температура < целевой температуры
   - Включается нагреватель
   - Вентилятор выключен

2. **Сушка** - когда температура в диапазоне [целевая, целевая+10°C]
   - Нагреватель выключен
   - Вентилятор работает на средней скорости

3. **Охлаждение** - когда температура > целевой+10°C
   - Нагреватель выключен
   - Вентилятор выключен

### Управление через MQTT:
- **Топик `/start`** - запуск сушки с указанием длительности
- **Топик `/stop`** - остановка сушки
- **Топик `/state/status`** - публикация текущего состояния

## Конфигурация

### Переменные окружения (.env):
```
SSID=your_wifi_ssid
PASS=your_wifi_password
MQTT_CLIENT_ID=your_client_id
MQTT_USERNAME=your_mqtt_username
MQTT_PASSWORD=your_mqtt_password
MQTT_URL=mqtt://your_broker_url
TARGET_TEMPERATURE=50
```

### Зависимости:
- `esp-idf-hal` - HAL для ESP32
- `esp-idf-svc` - сервисы ESP-IDF
- `embedded-svc` - встраиваемые сервисы
- `onewire` - протокол OneWire для DS18B20
- `serde` - сериализация/десериализация
- `chrono` - работа с временем
- `anyhow` - обработка ошибок

## Сборка и запуск

### Требования:
- Rust toolchain с поддержкой ESP32-C3
- ESP-IDF SDK
- Настроенные переменные окружения

### Команды:
```bash
# Сборка проекта
cargo build

# Запуск на устройстве
cargo run
```

## Структура проекта

```
src/
├── main.rs                 # Точка входа приложения
├── dryer/                  # Основной модуль сушилки
│   ├── mod.rs             # Состояние и сообщения
│   ├── heater/            # Система нагрева
│   │   └── mod.rs
│   ├── fan/               # Система вентиляции
│   │   └── mod.rs
│   └── sensor/            # Датчики
│       ├── mod.rs
│       └── temperature.rs # DS18B20 датчик
├── mqtt/                  # MQTT клиент
│   └── mod.rs
├── wifi/                  # WiFi подключение
│   └── mod.rs
├── time/                  # Система времени и таймеров
│   ├── mod.rs
│   ├── timer/
│   │   └── mod.rs
│   ├── limit/
│   │   └── mod.rs
│   └── remote/
│       ├── mod.rs
│       └── model.rs
└── schedule/              # Планировщик задач
    └── mod.rs
```

## Безопасность

- Используется WPA2 для WiFi подключения
- MQTT аутентификация через username/password
- Обработка ошибок с ограничением количества неудачных попыток

## Мониторинг

- Периодическая отправка состояния каждые 5 минут
- Логирование ошибок через `log` crate
- Автоматическое восстановление соединений

## Лицензия

Проект разработан для внутреннего использования.
